const CACHE_NAME="story-app-zaky-v1",RUNTIME_CACHE="runtime-cache-v1",API_BASE="https://story-api.dicoding.dev/v1";function getBasePath(){const e=self.location.pathname;console.log("[SW] Service Worker location:",e);const t=e.split("/").filter((e=>e&&"sw.js"!==e));if(t.length>0){const e="/"+t.join("/");return console.log("[SW] Detected base path:",e),e}return""}function getAppShellFiles(e=""){const t=self.location.origin;return[...new Set([`${e}/index.html`,`${e}/`,`${e}/favicon.png`,`${e}/images/logo.png`,`${e}/manifest.json`,`${t}${e}/index.html`,`${t}${e}/`,`${t}${e}/favicon.png`,`${t}${e}/images/logo.png`,`${t}${e}/manifest.json`])]}const IDB_DB_NAME="service-worker-db",IDB_STORE_NAME="outbox",IDB_VERSION=1;function openIdb(){return new Promise(((e,t)=>{const o=indexedDB.open(IDB_DB_NAME,1);o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("outbox")||t.createObjectStore("outbox",{keyPath:"id",autoIncrement:!0})},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))}async function idbAdd(e){const t=await openIdb();return new Promise(((o,n)=>{const a=t.transaction("outbox","readwrite").objectStore("outbox").add(e);a.onsuccess=()=>o(a.result),a.onerror=()=>n(a.error)}))}async function idbGetAll(){const e=await openIdb();return new Promise(((t,o)=>{const n=e.transaction("outbox","readonly").objectStore("outbox").getAll();n.onsuccess=()=>t(n.result),n.onerror=()=>o(n.error)}))}async function idbDelete(e){const t=await openIdb();return new Promise(((o,n)=>{const a=t.transaction("outbox","readwrite").objectStore("outbox").delete(e);a.onsuccess=()=>o(),a.onerror=()=>n(a.error)}))}async function safeCachePut(e,t,o){try{if(!o||200!==o.status||"basic"!==o.type)return;const n=await caches.open(e);await n.put(t,o.clone())}catch(e){console.warn("[SW] Cache put failed:",e)}}async function parseRequestBody(e){try{const t=e.headers.get("content-type")||"",o=e.clone();if(t.includes("application/json")){const e=await o.text();return e?JSON.parse(e):null}return await o.text()||null}catch(e){return console.warn("[SW] Failed to parse request body:",e),null}}async function handleApiRequest(e){try{const t=await fetch(e);return t&&t.ok&&safeCachePut(RUNTIME_CACHE,e,t),t}catch(t){console.log("[SW] Network failed, trying cache for:",e.url);return await caches.match(e)||new Response(JSON.stringify({error:!0,message:"Offline: Data tidak tersedia",offline:!0}),{status:503,headers:{"Content-Type":"application/json"}})}}async function handleNavigationRequest(e){const t=getBasePath(),o=self.location.origin;try{const t=await fetch(e);return t&&t.ok&&safeCachePut(CACHE_NAME,e,t),t}catch(n){console.log("[SW] Offline - returning cached App Shell for:",e.url);const a=[e.url,`${o}${t}/index.html`,`${o}${t}/`,`${t}/index.html`,`${t}/`,`${o}/index.html`,`${o}/`,"/index.html","/"];for(const e of a){const t=await caches.match(e);if(t)return console.log("[SW] Found cached App Shell at:",e),t}const s=await caches.match(e);return s?(console.log("[SW] Found cached response for request"),s):(console.log("[SW] No cache found, returning offline page"),new Response('<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>Offline</title></head><body><h1>Aplikasi sedang offline</h1><p>Silakan cek koneksi internet Anda dan refresh halaman.</p></body></html>',{status:200,headers:{"Content-Type":"text/html; charset=utf-8"}}))}}async function handleStaticAssetRequest(e){const t=await caches.match(e);if(t)return t;try{const t=await fetch(e);return t&&t.ok&&safeCachePut(RUNTIME_CACHE,e,t),t}catch(t){return await caches.match(e)||new Response("Resource tidak tersedia",{status:503})}}async function handleNonGETApiRequest(e){const t=e.clone();try{return await fetch(e)}catch(e){try{const e=await parseRequestBody(t),o={};for(const[e,n]of t.headers.entries())o[e]=n;const n={url:t.url,method:t.method,headers:o,body:e,timestamp:Date.now()},a=await idbAdd(n);if(console.log("[SW] Request queued in outbox, id:",a),"sync"in self.registration)try{await self.registration.sync.register("outbox-sync"),console.log("[SW] Background sync registered")}catch(e){console.warn("[SW] Background sync registration failed:",e)}return new Response(JSON.stringify({queued:!0,id:a,message:"Request akan di-sync saat online"}),{status:202,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("[SW] Failed to queue request:",e),new Response(JSON.stringify({error:"Failed to queue request"}),{status:500,headers:{"Content-Type":"application/json"}})}}}async function syncOutbox(){try{const e=await idbGetAll();if(!e||0===e.length)return void console.log("[SW] No items to sync");console.log(`[SW] Syncing ${e.length} queued items`);for(const t of e)try{const e=new Headers(t.headers||{});let o=null;null!==t.body&&void 0!==t.body&&("object"==typeof t.body?(o=JSON.stringify(t.body),e.has("content-type")||e.set("content-type","application/json")):o=String(t.body));const n=await fetch(t.url,{method:t.method,headers:e,body:o});if(n.ok)await idbDelete(t.id),console.log("[SW] ✓ Synced and removed item:",t.id);else{if(!(n.status>=400&&n.status<500))throw console.warn("[SW] ✗ Server error, will retry later:",t.id),new Error("Server error");await idbDelete(t.id),console.log("[SW] ✗ Removed item (client error):",t.id)}}catch(e){throw console.warn("[SW] ✗ Sync failed for item, will retry later:",t.id,e),e}}catch(e){console.error("[SW] Outbox sync error:",e)}}self.addEventListener("install",(e=>{console.log("[SW] Installing service worker...");const t=getAppShellFiles(getBasePath());e.waitUntil((async()=>{try{const e=await caches.open(CACHE_NAME);console.log("[SW] Caching App Shell files:",t);const o=(await Promise.allSettled(t.map((async t=>{try{const o=await fetch(t);return o&&o.ok?(await e.put(t,o),console.log("[SW] ✓ Cached:",t),{url:t,success:!0}):(console.warn(`[SW] ✗ Failed to cache ${t}: HTTP ${o.status}`),{url:t,success:!1})}catch(e){return console.warn(`[SW] ✗ Error caching ${t}:`,e.message),{url:t,success:!1}}})))).filter((e=>"fulfilled"===e.status&&e.value?.success)).length;console.log(`[SW] App Shell cached: ${o}/${t.length} files`)}catch(e){console.error("[SW] Install error:",e)}})()),self.skipWaiting()})),self.addEventListener("activate",(e=>{console.log("[SW] Activating service worker..."),e.waitUntil((async()=>{try{const e=(await caches.keys()).filter((e=>e!==CACHE_NAME&&e!==RUNTIME_CACHE)).map((e=>(console.log("[SW] Deleting old cache:",e),caches.delete(e))));await Promise.all(e),console.log("[SW] Old caches cleaned up")}catch(e){console.error("[SW] Activate cleanup error:",e)}await self.clients.claim(),console.log("[SW] Service worker activated and claimed clients")})())})),self.addEventListener("fetch",(e=>{const{request:t}=e,o=new URL(t.url);"GET"===t.method?("localhost"===o.hostname||"127.0.0.1"===o.hostname)&&["/sockjs-node","/ws","/webpack-dev-server","/__webpack","/hot-update"].some((e=>o.pathname.includes(e)))||(o.origin!==new URL(API_BASE).origin?"navigate"===t.mode||t.headers.get("accept")?.includes("text/html")?e.respondWith(handleNavigationRequest(t)):e.respondWith(handleStaticAssetRequest(t)):e.respondWith(handleApiRequest(t))):o.origin===new URL(API_BASE).origin&&e.respondWith(handleNonGETApiRequest(t))})),self.addEventListener("sync",(e=>{"outbox-sync"===e.tag&&(console.log("[SW] Background sync triggered"),e.waitUntil(syncOutbox()))})),self.addEventListener("push",(e=>{console.log("[SW] Push notification received");let t={title:"Story App",body:"Anda mendapat notifikasi baru"};if(e.data)try{const o=e.data.json();t={title:o.title||o.notification?.title||"Story App",body:o.body||o.notification?.body||o.message||"Anda mendapat notifikasi baru",icon:o.icon||o.notification?.icon,image:o.image||o.notification?.image,badge:o.badge,tag:o.tag||"story-notification",data:o.data||o,requireInteraction:o.requireInteraction||!1,vibrate:o.vibrate||[200,100,200],timestamp:o.timestamp||Date.now()}}catch(o){t.body=e.data.text()}const o=getBasePath(),n=o?`${o}/images/logo.png`:"/images/logo.png",a={body:t.body,icon:t.icon||n,badge:t.badge||n,image:t.image,data:t.data||{},tag:t.tag,requireInteraction:t.requireInteraction,timestamp:t.timestamp,vibrate:t.vibrate,actions:t.data?.storyId?[{action:"view",title:"Lihat Detail",icon:n},{action:"close",title:"Tutup"}]:[]};e.waitUntil(self.registration.showNotification(t.title,a))})),self.addEventListener("notificationclick",(e=>{console.log("[SW] Notification clicked, action:",e.action),e.notification.close();const t=e.notification.data||{},o=getBasePath(),n=o?`${o}/#/`:"/#/";if("view"===e.action&&t.storyId)e.waitUntil(clients.openWindow(`${n}?storyId=${t.storyId}`));else{if("close"===e.action)return;t.storyId?e.waitUntil(clients.openWindow(`${n}?storyId=${t.storyId}`)):t.url?e.waitUntil(clients.openWindow(t.url)):e.waitUntil(clients.openWindow(n))}})),self.addEventListener("message",(e=>{console.log("[SW] Message received:",e.data);const t=e.ports?.[0];t?(async()=>{try{let o;o=e.data&&"PING"===e.data.cmd?{pong:Date.now()}:{ok:!0,received:e.data},t.postMessage({ok:!0,result:o})}catch(e){t.postMessage({ok:!1,error:String(e)})}})():clients.matchAll({includeUncontrolled:!0}).then((t=>{for(const o of t)try{o.postMessage({info:"Message received",data:e.data})}catch(e){}}))}));