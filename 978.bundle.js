"use strict";(self.webpackChunkstory_app_zaky=self.webpackChunkstory_app_zaky||[]).push([[978],{978:(t,o,i)=>{i.r(o),i.d(o,{initPush:()=>a});const n={BASE_URL:"https://story-api.dicoding.dev/v1"};function e(){let t=document.getElementById("push-toggle");return t||(t=document.createElement("button"),t.id="push-toggle",t.setAttribute("type","button"),t.className="btn push-notification-btn",t.style.position="fixed",t.style.right="16px",t.style.bottom="16px",t.style.zIndex="9999",t.style.padding="12px 20px",t.style.backgroundColor="#2196F3",t.style.color="white",t.style.border="none",t.style.borderRadius="8px",t.style.cursor="pointer",t.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",t.style.fontSize="14px",t.style.fontWeight="600",t.setAttribute("aria-label","Toggle Push Notifications"),document.body.appendChild(t)),t}async function a(t){const o=e();if(!("PushManager"in window)||!("Notification"in window))return o.textContent="üîî Notifikasi Tidak Didukung",o.style.backgroundColor="#9E9E9E",void(o.disabled=!0);try{if(!t){if(!("serviceWorker"in navigator))return o.textContent="üîî Service Worker Tidak Didukung",o.style.backgroundColor="#9E9E9E",void(o.disabled=!0);t=await navigator.serviceWorker.ready}}catch(t){return console.warn("Service worker not ready, push init aborted.",t),o.textContent="üîî Menunggu Service Worker...",o.style.backgroundColor="#FF9800",void setTimeout((()=>a(null)),3e3)}async function i(){try{const i=await t.pushManager.getSubscription();"granted"===Notification.permission&&i?(o.textContent="üîî Notifikasi Aktif",o.style.backgroundColor="#4CAF50"):(o.textContent="üîî Aktifkan Notifikasi",o.style.backgroundColor="#2196F3")}catch(t){console.error("Error while updating push UI",t),o.textContent="üîî Aktifkan Notifikasi",o.style.backgroundColor="#2196F3"}}await i();const s=o.cloneNode(!0);o.parentNode.replaceChild(s,o);const r=document.getElementById("push-toggle");r.addEventListener("click",(async()=>{try{if(console.log("üîî Push notification button clicked"),"granted"===Notification.permission){const c=await t.pushManager.getSubscription();if(c){console.log("üîî Menampilkan test notification...");try{const d=window.location.origin+"/images/logo.png";console.log("Icon path:",d);const u={body:"Ini adalah test notifikasi dari Story App!",icon:d,badge:d,tag:"test-notification-"+Date.now(),requireInteraction:!1,vibrate:[200,100,200]};console.log("Notification options:",u);const g=await t.showNotification("Test Notification",u);return console.log("‚úÖ Test notification ditampilkan:",g),void setTimeout((()=>{confirm("Test notification berhasil! Apakah Anda ingin menonaktifkan notifikasi?")?l(c):i()}),500)}catch(k){console.error("‚ùå Gagal menampilkan test notification:",k),alert("Error: "+k.message+"\n\nLihat console untuk detail.")}async function l(t){try{const o=await t.unsubscribe();console.log("‚úÖ Unsubscribed locally:",o);try{await async function(t){const o="/v1/unsubscribe",i=n&&n.BASE_URL?`${n.BASE_URL.replace(/\/$/,"")}/unsubscribe`:null;async function e(o){const i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const t=await i.text().catch((()=>""));throw new Error(`Server responded ${i.status} ${i.statusText} ${t}`)}return i.json().catch((()=>({})))}try{return await e(o)}catch(t){if(console.warn(`Unsubscribe post to ${o} failed:`,t),i)try{return await e(i)}catch(t){throw console.error(`Unsubscribe post to fallback ${i} failed:`,t),t}throw t}}({endpoint:t.endpoint,keys:t.toJSON().keys}),console.log("‚úÖ Subscription dihapus dari server")}catch(t){console.warn("‚ö†Ô∏è Failed to remove subscription from server",t)}alert("‚úÖ Notifikasi telah dinonaktifkan."),await i()}catch(t){console.error("Error during unsubscribe:",t),alert("Error saat menonaktifkan notifikasi: "+t.message)}}return void await l(c)}console.log("Permission granted, subscribing...")}console.log("Requesting notification permission...");const o=await Notification.requestPermission();if(console.log("Notification permission:",o),"granted"!==o)return alert("Izin notifikasi tidak diberikan. Silakan aktifkan di pengaturan browser."),void await i();console.log("üîî Menampilkan test notification setelah permission granted...");try{const p=window.location.origin+"/images/logo.png";console.log("Icon path:",p);const f={body:"Anda akan menerima notifikasi dari Story App.",icon:p,badge:p,tag:"notification-enabled-"+Date.now(),vibrate:[200,100,200]};console.log("Notification options:",f);const b=await t.showNotification("Notifikasi Diaktifkan!",f);console.log("‚úÖ Test notification ditampilkan setelah permission granted:",b)}catch(h){console.error("‚ùå Gagal menampilkan test notification:",h)}r.textContent="‚è≥ Memproses...",r.disabled=!0,console.log("Fetching VAPID public key...");const e=await async function(){const t=n&&n.BASE_URL?`${n.BASE_URL.replace(/\/$/,"")}/vapidPublicKey`:null;async function o(t){const o=await fetch(t);if(!o.ok)throw new Error(`Failed to fetch VAPID key: ${o.status}`);const i=await o.json();return i.publicKey||i.public||i}try{return await o("/v1/vapidPublicKey")}catch(i){if(console.warn("Fetching VAPID key from relative URL failed:",i),t)try{return await o(t)}catch(t){return console.error("Error fetching VAPID public key from fallback:",t),"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}return"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}}();if(!e)return alert("Gagal mendapatkan VAPID public key dari server."),r.disabled=!1,void await i();console.log("‚úÖ VAPID public key received"),console.log("Subscribing to push notifications...");const a=function(t){const o=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),i=atob(o),n=new Uint8Array(i.length);for(let t=0;t<i.length;++t)n[t]=i.charCodeAt(t);return n}(e),s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a});console.log("‚úÖ Push subscription berhasil:",s);try{await async function(t){const o="/v1/subscribe",i=n&&n.BASE_URL?`${n.BASE_URL.replace(/\/$/,"")}/subscribe`:null;async function e(o){console.log("[Push] POST to:",o);const i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const t=await i.text().catch((()=>""));throw new Error(`Server responded ${i.status} ${i.statusText} ${t}`)}return i.json().catch((()=>({})))}console.log("[Push] Attempting to send subscription:"),console.log("[Push] - Relative URL:",o),console.log("[Push] - Fallback URL:",i),console.log("[Push] - CONFIG.BASE_URL:",n?.BASE_URL);try{return await e(o)}catch(t){if(console.warn(`[Push] Posting subscription to ${o} failed:`,t),i)try{return console.log("[Push] Trying fallback URL:",i),await e(i)}catch(t){throw console.error(`[Push] Posting subscription to fallback ${i} failed:`,t),t}throw t}}(s),console.log("‚úÖ Push notification subscription berhasil disimpan ke server!"),console.log("üîî Menampilkan notifikasi sukses...");try{const y=window.location.origin+"/images/logo.png",w={body:"Anda akan menerima notifikasi dari Story App.",icon:y,badge:y,tag:"subscription-success-"+Date.now(),vibrate:[200,100,200]};console.log("Success notification options:",w),await t.showNotification("Notifikasi Berhasil Diaktifkan!",w),console.log("‚úÖ Success notification ditampilkan")}catch(m){console.error("‚ùå Gagal menampilkan success notification:",m)}alert("‚úÖ Notifikasi berhasil diaktifkan! Anda akan menerima notifikasi dari server.")}catch(v){console.error("‚ùå Failed to send subscription to server:",v),console.log("‚ÑπÔ∏è Ini normal untuk development. Subscription lokal sudah berhasil dibuat."),console.log("üîî Menampilkan success notification...");try{const S=window.location.origin+"/images/logo.png",A={body:"Notifikasi berhasil diaktifkan! Anda dapat menerima notifikasi.",icon:S,badge:S,tag:"subscription-success-local-"+Date.now(),vibrate:[200,100,200]};console.log("Success notification options:",A),await t.showNotification("Notifikasi Berhasil Diaktifkan!",A),console.log("‚úÖ Success notification ditampilkan")}catch(E){console.error("‚ùå Gagal menampilkan success notification:",E)}"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?alert('‚úÖ Notifikasi berhasil diaktifkan!\n\nSubscription lokal berhasil dibuat. Untuk testing, Anda dapat:\n1. Menggunakan DevTools untuk mengirim test notification\n2. Atau gunakan "npm run start-dev" untuk development dengan proxy\n\nNotifikasi akan berfungsi dengan baik di production.'):alert("‚úÖ Notifikasi berhasil diaktifkan!\n\nSubscription lokal berhasil dibuat. Jika ada masalah koneksi ke server, notifikasi tetap akan berfungsi secara lokal.")}r.disabled=!1,await i()}catch(N){console.error("‚ùå Error in push toggle handler:",N),alert("Terjadi kesalahan saat menyiapkan notifikasi: "+N.message+"\n\nLihat console untuk detail."),r.disabled=!1,await i()}}))}document.body?e():"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{e()})):setTimeout((()=>{document.body&&e()}),100),"undefined"!=typeof window&&window.addEventListener("load",(()=>{document.getElementById("push-toggle")||e()}))}}]);