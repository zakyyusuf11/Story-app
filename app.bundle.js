(()=>{"use strict";var e,t,n={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,a=0;a<t.length;a++)if(t[a].identifier===e){n=a;break}return n}function a(e,a){for(var o={},i=[],s=0;s<e.length;s++){var l=e[s],d=a.base?l[0]+a.base:l[0],c=o[d]||0,p="".concat(d," ").concat(c);o[d]=c+1;var m=n(p),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(u);else{var g=r(u,a);a.byIndex=s,t.splice(s,0,{identifier:p,updater:g,references:1})}i.push(p)}return i}function r(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var o=a(e=e||[],r=r||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var s=n(o[i]);t[s].references--}for(var l=a(e,r),d=0;d<o.length;d++){var c=n(o[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}o=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},159:(e,t,n)=>{n.d(t,{A:()=>s});var a=n(601),r=n.n(a),o=n(314),i=n.n(o)()(r());i.push([e.id,"@import url(https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap);"]),i.push([e.id,'/* =========================================================\n   Theme: Green Learning Story App\n   Author: Zaky Yusuf\n   Description: Clean, responsive, green-themed UI\n   ========================================================= */\n\n/* ------------------ Fonts ------------------ */\n\n/* ------------------ Root Variables ------------------ */\n:root {\n  --bg: #f9fdf9;\n  --card: #ffffff;\n  --text: #1b1b1b;\n  --muted: #6b6b6b;\n  --primary: #2e7d32;    /* dark green */\n  --primary-2: #4caf50;  /* medium green */\n  --accent: #81c784;     /* light green */\n  --danger: #e53935;\n  --shadow: 0 6px 18px rgba(34, 34, 34, 0.08);\n  --radius: 12px;\n}\n\n/* ------------------ Base & Reset ------------------ */\n* {\n  box-sizing: border-box;\n}\n\nhtml, body {\n  height: 100%;\n}\n\nbody {\n  margin: 0;\n  font-family: \'Poppins\', system-ui, -apple-system, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial;\n  background: var(--bg);\n  color: var(--text);\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  line-height: 1.45;\n}\n\n/* ------------------ Header ------------------ */\nheader {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 12px;\n  padding: 14px 18px;\n  background: linear-gradient(90deg, var(--primary), var(--primary-2));\n  color: #fff;\n  box-shadow: var(--shadow);\n  position: sticky;\n  top: 0;\n  z-index: 40;\n}\n\n.logo {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.logo img {\n  height: 36px;\n  width: auto;\n}\n\n.site-title {\n  font-weight: 700;\n  font-size: 1.1rem;\n  letter-spacing: 0.2px;\n}\n\n/* Navigation */\n.nav-list {\n  display: flex;\n  gap: 8px;\n  align-items: center;\n}\n\n.nav-list a {\n  color: rgba(255, 255, 255, 0.95);\n  text-decoration: none;\n  padding: 8px 10px;\n  border-radius: 8px;\n  font-weight: 600;\n}\n\n.nav-list a:hover {\n  background: rgba(255, 255, 255, 0.08);\n  outline: none;\n}\n\n/* ------------------ Auth ------------------ */\n.auth-container {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.auth-welcome {\n  font-size: 0.95rem;\n  margin-right: 6px;\n}\n\n/* Buttons */\n.btn {\n  background: var(--primary-2);\n  border: none;\n  padding: 8px 12px;\n  border-radius: 8px;\n  color: #fff;\n  cursor: pointer;\n  font-weight: 600;\n  transition: background 0.2s ease;\n}\n\n.btn:hover {\n  background: var(--accent);\n}\n\n.btn.small {\n  padding: 6px 8px;\n  font-size: 0.9rem;\n  border-radius: 6px;\n}\n\n.btn.secondary {\n  background: transparent;\n  border: 2px solid rgba(255, 255, 255, 0.18);\n  color: #fff;\n}\n\n.btn.danger {\n  background: var(--danger);\n}\n\n/* ------------------ Layout ------------------ */\n.container {\n  max-width: 1100px;\n  margin: 18px auto;\n  padding: 18px;\n}\n\n.main-content {\n  min-height: 60vh;\n  padding-bottom: 40px;\n}\n\n/* ------------------ Story Cards ------------------ */\n.stories-list {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 14px;\n}\n\n.story-item {\n  background: var(--card);\n  border-radius: var(--radius);\n  padding: 10px;\n  box-shadow: var(--shadow);\n  overflow: hidden;\n  display: flex;\n  gap: 10px;\n  align-items: flex-start;\n  transition: transform 0.2s ease;\n}\n\n.story-item:hover {\n  transform: translateY(-2px);\n}\n\n.story-item img {\n  width: 110px;\n  height: 110px;\n  object-fit: cover;\n  border-radius: 8px;\n}\n\n.story-meta h3 {\n  margin: 0;\n  font-size: 1rem;\n}\n\n.story-meta .desc {\n  margin: 6px 0;\n  color: var(--muted);\n  font-size: 0.95rem;\n}\n\n.story-meta .time {\n  font-size: 0.8rem;\n  color: var(--muted);\n}\n\n/* ------------------ Map Layout ------------------ */\n.map-layout {\n  display: grid;\n  grid-template-columns: 2fr 1fr;\n  gap: 12px;\n  align-items: start;\n}\n\n.map-list {\n  background: var(--card);\n  padding: 12px;\n  border-radius: var(--radius);\n  box-shadow: var(--shadow);\n  max-height: 500px;\n  overflow: auto;\n}\n\n.map-story-item {\n  padding: 10px;\n  border-bottom: 1px solid #eee;\n  cursor: pointer;\n}\n\n.map-story-item:focus {\n  outline: 3px solid rgba(76, 175, 80, 0.25);\n}\n\n/* ------------------ Forms ------------------ */\n.form-group {\n  margin-bottom: 12px;\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n}\n\nlabel {\n  font-weight: 600;\n  font-size: 0.95rem;\n}\n\ninput[type="text"],\ninput[type="email"],\ninput[type="password"],\ntextarea,\ninput[type="file"] {\n  padding: 10px;\n  border-radius: 8px;\n  border: 1px solid #e6e6e6;\n  background: #fff;\n}\n\ntextarea {\n  resize: vertical;\n  min-height: 80px;\n}\n\n/* ------------------ Specific Pages ------------------ */\n.add-story-page,\n.login-page,\n.add-story-section {\n  max-width: 920px;\n  margin: 12px auto;\n  background: var(--card);\n  padding: 18px;\n  border-radius: var(--radius);\n  box-shadow: var(--shadow);\n}\n\n/* ------------------ Camera ------------------ */\n#camera-video {\n  width: 100%;\n  border-radius: 8px;\n  display: block;\n}\n\n#camera-canvas {\n  max-width: 100%;\n  border-radius: 8px;\n}\n\n/* ------------------ Accessibility ------------------ */\n.skip-to-content {\n  position: absolute;\n  left: -999px;\n  top: auto;\n  width: 1px;\n  height: 1px;\n  overflow: hidden;\n}\n\n.skip-to-content:focus {\n  left: 10px;\n  top: 10px;\n  background: var(--primary);\n  color: #fff;\n  padding: 8px;\n  border-radius: 6px;\n  z-index: 9999;\n}\n\na:focus,\nbutton:focus,\ninput:focus,\ntextarea:focus {\n  outline: 3px solid rgba(76, 175, 80, 0.18);\n  outline-offset: 2px;\n}\n\n/* ------------------ Transitions ------------------ */\n.fade-in {\n  animation: fadeIn 0.28s ease-in;\n}\n\n.fade-out {\n  opacity: 0.01;\n  transition: opacity 0.18s ease-out;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(6px);\n  }\n  to {\n    opacity: 1;\n    transform: none;\n  }\n}\n\n/* ------------------ Responsive ------------------ */\n@media (max-width: 1024px) {\n  .stories-list {\n    grid-template-columns: repeat(2, 1fr);\n  }\n\n  .map-layout {\n    grid-template-columns: 1fr 0.9fr;\n  }\n\n  .container {\n    padding: 14px;\n  }\n}\n\n@media (max-width: 768px) {\n  header {\n    padding: 10px;\n    flex-direction: column;\n    align-items: flex-start;\n  }\n\n  .stories-list {\n    grid-template-columns: 1fr;\n  }\n\n  .map-layout {\n    grid-template-columns: 1fr;\n  }\n\n  .container {\n    padding: 12px;\n  }\n\n  .logo img {\n    height: 30px;\n  }\n}\n\n@media (max-width: 420px) {\n  .story-item img {\n    width: 84px;\n    height: 84px;\n  }\n\n  .site-title {\n    font-size: 1rem;\n  }\n}\n\n/* ------------------ Helpers ------------------ */\n.form-actions {\n  display: flex;\n  gap: 8px;\n  align-items: center;\n}\n\n.message {\n  margin-top: 10px;\n  color: var(--muted);\n}\n',""]);const s=i},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",a=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),a&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),a&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,a,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(a)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(i[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);a&&i[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=o),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),r&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=r):c[4]="".concat(r)),t.push(c))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var a=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var a="";n.supports&&(a+="@supports (".concat(n.supports,") {")),n.media&&(a+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(a+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),a+=n.css,r&&(a+="}"),n.media&&(a+="}"),n.supports&&(a+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(a,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},a={};function r(e){var t=a[e];if(void 0!==t)return t.exports;var o=a[e]={id:e,exports:{}};return n[e](o,o.exports,r),o.exports}r.m=n,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,n)=>(r.f[n](e,t),t)),[])),r.u=e=>e+".bundle.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="story-app-zaky:",r.l=(n,a,o,i)=>{if(e[n])e[n].push(a);else{var s,l;if(void 0!==o)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var p=d[c];if(p.getAttribute("src")==n||p.getAttribute("data-webpack")==t+o){s=p;break}}s||(l=!0,(s=document.createElement("script")).charset="utf-8",r.nc&&s.setAttribute("nonce",r.nc),s.setAttribute("data-webpack",t+o),s.src=n),e[n]=[a];var m=(t,a)=>{s.onerror=s.onload=null,clearTimeout(u);var r=e[n];if(delete e[n],s.parentNode&&s.parentNode.removeChild(s),r&&r.forEach((e=>e(a))),t)return t(a)},u=setTimeout(m.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=m.bind(null,s.onerror),s.onload=m.bind(null,s.onload),l&&document.head.appendChild(s)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="/",(()=>{var e={524:0};r.f.j=(t,n)=>{var a=r.o(e,t)?e[t]:void 0;if(0!==a)if(a)n.push(a[2]);else{var o=new Promise(((n,r)=>a=e[t]=[n,r]));n.push(a[2]=o);var i=r.p+r.u(t),s=new Error;r.l(i,(n=>{if(r.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var o=n&&("load"===n.type?"missing":n.type),i=n&&n.target&&n.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+i+")",s.name="ChunkLoadError",s.type=o,s.request=i,a[1](s)}}),"chunk-"+t,t)}};var t=(t,n)=>{var a,o,[i,s,l]=n,d=0;if(i.some((t=>0!==e[t]))){for(a in s)r.o(s,a)&&(r.m[a]=s[a]);l&&l(r)}for(t&&t(n);d<i.length;d++)o=i[d],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0},n=self.webpackChunkstory_app_zaky=self.webpackChunkstory_app_zaky||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),r.nc=void 0;var o=r(72),i=r.n(o),s=r(825),l=r.n(s),d=r(659),c=r.n(d),p=r(56),m=r.n(p),u=r(540),g=r.n(u),h=r(113),y=r.n(h),f=r(159),b={};b.styleTagTransform=y(),b.setAttributes=m(),b.insert=c().bind(null,"head"),b.domAPI=l(),b.insertStyleElement=g(),i()(f.A,b),f.A&&f.A.locals&&f.A.locals;const v="favorites",w="offlineStories",x="cachedStories",k="outbox";async function S(){return new Promise(((e,t)=>{const n=indexedDB.open("StoryAppDB",3);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result),n.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion||0;if(!t.objectStoreNames.contains(w)){const e=t.createObjectStore(w,{keyPath:"id"});e.createIndex("synced","synced",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(t.objectStoreNames.contains(x)||t.createObjectStore(x,{keyPath:"id",autoIncrement:!1}).createIndex("timestamp","timestamp",{unique:!1}),t.objectStoreNames.contains(v)){if(n<2){const t=e.target.transaction.objectStore(v);t.indexNames.contains("savedAt")||t.createIndex("savedAt","savedAt",{unique:!1})}}else t.createObjectStore(v,{keyPath:"id",autoIncrement:!1}).createIndex("savedAt","savedAt",{unique:!1});t.objectStoreNames.contains(k)||t.createObjectStore(k,{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})}}))}async function E(){try{const e=await S();if(!e.objectStoreNames.contains(v))return console.warn("[idb] Favorites store belum tersedia"),[];const t=e.transaction(v,"readonly").objectStore(v);return new Promise(((e,n)=>{const a=t.getAll();a.onsuccess=()=>{const t=a.result;e(Array.isArray(t)?t:[])},a.onerror=()=>{console.error("[idb] Error getting favorites:",a.error),e([])}}))}catch(e){return console.error("Error getting favorites:",e),[]}}let I=null;const T="https://story-api.dicoding.dev/v1",A={REGISTER:`${T}/register`,LOGIN:`${T}/login`,STORIES:`${T}/stories`};async function _({photoFile:e,description:t,lat:n=null,lon:a=null}){const r=localStorage.getItem("token");if(!r)throw new Error("Authorization token required");const o=new FormData;o.append("photo",e),o.append("description",t),n&&a&&(o.append("lat",n),o.append("lon",a));const i=await fetch(A.STORIES,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:o});if(!i.ok){const e=await i.text();throw new Error(`Post story failed: ${i.status} ${e}`)}return await i.json()}const $={"/":new class{async render(){return'\n      <section class="container">\n        <h1>Home Page</h1>\n        <p>\n          <button type="button" class="btn" data-hash="#/add" aria-label="Tambah story baru">+ Tambah Story</button>\n          <button type="button" class="btn" data-hash="#/map" aria-label="Lihat peta cerita">Lihat Peta</button>\n        </p>\n\n        <h2>Story</h2>\n        <div id="stories-list" class="stories-list" aria-live="polite"></div>\n\n        <h2>Favorit Anda</h2>\n        <div id="favorites-list" class="stories-list" aria-live="polite"></div>\n      </section>\n    '}async afterRender(){await this._renderStories(),await this._renderFavorites(),document.body.addEventListener("click",(e=>{const t=e.target.closest("button[data-hash]");if(!t)return;const n=t.getAttribute("data-hash");n&&(location.hash=n)}));const e=document.getElementById("stories-list");e&&e.addEventListener("click",(async e=>{const t=e.target.closest(".save-btn");if(!t)return;const n=t.getAttribute("data-story");if(!n)return;let a=null;try{a=JSON.parse(decodeURIComponent(n))}catch(e){return void console.error("Gagal parse data-story",e)}try{await async function(e){try{const t=await S();if(!t.objectStoreNames.contains(v))throw console.error("[idb] Favorites store tidak tersedia. Silakan refresh halaman."),new Error("Favorites store tidak tersedia.");const n=t.transaction(v,"readwrite").objectStore(v),a={id:e.id,name:e.name||"",description:e.description||"",photoUrl:e.photoUrl||e.photo||"",createdAt:e.createdAt||(new Date).toISOString(),lat:e.lat||null,lon:e.lon||null,savedAt:(new Date).toISOString()};return new Promise(((e,t)=>{const r=n.put(a);r.onsuccess=()=>e(a),r.onerror=()=>t(r.error)}))}catch(e){throw console.error("Error saving favorite:",e),e}}(a),await this._renderFavorites(),t.textContent="Tersimpan",t.disabled=!0}catch(e){console.error("Gagal menyimpan favorit",e)}}));const t=document.getElementById("favorites-list");t&&t.addEventListener("click",(async e=>{const t=e.target.closest(".delete-fav-btn");if(!t)return;const n=t.getAttribute("data-id");try{await async function(e){try{const t=await S();if(!t.objectStoreNames.contains(v))return console.warn("[idb] Favorites store tidak tersedia"),!1;const n=t.transaction(v,"readwrite").objectStore(v);return new Promise(((t,a)=>{const r=n.delete(e);r.onsuccess=()=>t(!0),r.onerror=()=>a(r.error)}))}catch(e){throw console.error("Error deleting favorite:",e),e}}(n),await this._renderFavorites(),await this._renderStories()}catch(e){console.error("Gagal menghapus favorit",e)}}))}async _renderStories(){const e=document.getElementById("stories-list");if(e){e.innerHTML="<p>Memuat story...</p>";try{const t=localStorage.getItem("token"),n=await E(),a=new Set((n||[]).map((e=>String(e.id)))),r=t?{Authorization:`Bearer ${t}`}:{},o=await fetch("https://story-api.dicoding.dev/v1/stories?location=1",{headers:r}),i=await o.json(),s=i.listStory||i.list||[];if(!Array.isArray(s)||0===s.length)return void(e.innerHTML="<p>Tidak ada story.</p>");e.innerHTML=s.map((e=>{const t=e.id,n=e.name||"Tanpa Nama",r=e.description||"",o=e.createdAt,i=e.photoUrl||"",s=void 0!==e.lat&&null!==e.lat?e.lat:null,l=void 0!==e.lon&&null!==e.lon?e.lon:null,d={id:t,name:n,description:r,createdAt:o,photoUrl:i,lat:s,lon:l},c=encodeURIComponent(JSON.stringify(d)),p=a.has(String(t)),m=p?"Tersimpan":"Simpan",u=p?"disabled":"";return`\n            <article class="story-card" role="article" aria-labelledby="story-${this._escapeHtml(String(t))}">\n              <div class="story-content">\n                ${i?`<img src="${this._escapeHtml(i)}" alt="Foto ${this._escapeHtml(n)}" class="story-image" loading="lazy" style="width:100%;border-radius:8px;margin-bottom:8px;">`:""}\n                <h2 id="story-${this._escapeHtml(String(t))}">${this._escapeHtml(n)}</h2>\n                <p>${r?this._escapeHtml(r.substring(0,150))+(r.length>150?"...":""):"Tidak ada deskripsi"}</p>\n                <small>Dibuat pada: ${o?new Date(o).toLocaleDateString("id-ID"):"‚Äî"}</small>\n                ${null!==s&&null!==l?`<p><small>üìç Lokasi: ${this._escapeHtml(String(s))}, ${this._escapeHtml(String(l))}</small></p>`:""}\n                <p>\n                  <button class="save-btn btn" data-id="${this._escapeHtml(String(t))}" data-story="${c}" aria-label="Simpan story ${this._escapeHtml(n)}" ${u}>${m}</button>\n                </p>\n              </div>\n            </article>\n          `})).join("")}catch(t){e.innerHTML=`<p>Gagal memuat story: ${this._escapeHtml(String(t))}</p>`,console.error(t)}}}async _renderFavorites(){const e=document.getElementById("favorites-list");if(e){e.innerHTML="<p>Memuat favorit...</p>";try{const t=await E();if(!t||0===t.length)return void(e.innerHTML="<p>Tidak ada favorit.</p>");e.innerHTML=t.map((e=>`\n          <article class="story-card" role="article" aria-labelledby="fav-${this._escapeHtml(String(e.id))}">\n            <div class="story-content">\n              ${e.photoUrl?`<img src="${this._escapeHtml(e.photoUrl)}" alt="Foto ${this._escapeHtml(e.name)}" class="story-image" loading="lazy" style="width:100%;border-radius:8px;margin-bottom:8px;">`:""}\n              <h3 id="fav-${this._escapeHtml(String(e.id))}">${this._escapeHtml(e.name)}</h3>\n              <p>${e.description?this._escapeHtml(e.description.substring(0,150))+(e.description.length>150?"...":""):"Tidak ada deskripsi"}</p>\n              <small>Dibuat pada: ${e.createdAt?new Date(e.createdAt).toLocaleDateString("id-ID"):"‚Äî"}</small>\n              ${e.lat&&e.lon?`<p><small>üìç Lokasi: ${this._escapeHtml(String(e.lat))}, ${this._escapeHtml(String(e.lon))}</small></p>`:""}\n              <p>\n                <button class="delete-fav-btn btn" data-id="${this._escapeHtml(String(e.id))}" aria-label="Hapus favorit ${this._escapeHtml(e.name)}">Hapus</button>\n              </p>\n            </div>\n          </article>\n        `)).join("")}catch(t){e.innerHTML=`<p>Gagal memuat favorit: ${this._escapeHtml(String(t))}</p>`,console.error(t)}}}_escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}},"/about":new class{async render(){return'\n      <section class="container">\n        <h1>About Page</h1>\n      </section>\n    '}async afterRender(){}},"/map":new class{async render(){return'\n      <section class="container">\n        <h1>Peta Story</h1>\n        <div class="map-layout">\n          <div id="map" style="height:500px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>\n          <aside class="map-list" aria-label="Daftar cerita dengan lokasi">\n            <h2>Daftar Cerita</h2>\n            <div id="story-list" class="story-list" role="list"></div>\n          </aside>\n        </div>\n      </section>\n    '}async afterRender(){let e=[];try{const t=localStorage.getItem("token"),n=document.getElementById("story-list");if(!t)return void(n.innerHTML="<p>‚ö† Silakan login terlebih dahulu untuk melihat cerita di peta.</p>");const a=await fetch("https://story-api.dicoding.dev/v1/stories?location=1",{headers:{Authorization:`Bearer ${t}`}}),r=await a.json();if(r.error)return void(n.innerHTML=`<p>Gagal memuat data: ${r.message}</p>`);const o=r.listStory.filter((e=>e.lat&&e.lon));this._renderList(o),I&&(I.remove(),I=null),I=L.map("map").setView([-2.5489,118.0149],4);const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap contributors"}).addTo(I),s=L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenTopoMap contributors"});L.control.layers({OpenStreetMap:i,Topographic:s}).addTo(I);const l=[];o.forEach(((t,n)=>{const a=parseFloat(t.lat),r=parseFloat(t.lon),i=`\n          <div style="max-width:180px;">\n            <img src="${t.photoUrl}" alt="Foto ${t.name}" style="width:100%;border-radius:8px;margin-bottom:6px;">\n            <strong>${t.name}</strong>\n            <p style="font-size:0.9em; color:#555;">${t.description||"Tidak ada deskripsi."}</p>\n          </div>\n        `,s=L.marker([a,r]).addTo(I);s.bindPopup(i),s.on("click",(()=>this._activate(n,e,o))),e.push(s),l.push([a,r])})),l.length>0&&I.fitBounds(l,{padding:[20,20]}),document.querySelectorAll(".story-item").forEach(((t,n)=>{t.addEventListener("click",(()=>this._activate(n,e,o))),t.addEventListener("keydown",(t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this._activate(n,e,o))}))}))}catch(e){console.error("Kesalahan memuat peta:",e),document.getElementById("story-list").innerHTML="<p>Terjadi kesalahan koneksi saat memuat data cerita.</p>"}}_renderList(e){const t=document.getElementById("story-list");0!==e.length?t.innerHTML=e.map(((e,t)=>`\n      <article class="story-item" \n        data-index="${t}" \n        role="listitem" \n        tabindex="0" \n        aria-label="Cerita oleh ${e.name}">\n        <img src="${e.photoUrl}" \n             alt="Foto ${e.name}" \n             class="story-image" \n             loading="lazy" \n             style="width:100%;border-radius:8px;">\n        <div class="story-meta">\n          <h3>${e.name}</h3>\n          <p>${e.description?e.description.slice(0,100)+"...":"Tidak ada deskripsi."}</p>\n          <small>Lat: ${e.lat} | Lon: ${e.lon}</small>\n        </div>\n      </article>\n    `)).join(""):t.innerHTML="<p>Tidak ada cerita dengan lokasi.</p>"}_activate(e,t,n){document.querySelectorAll(".story-item").forEach((e=>e.classList.remove("active")));const a=document.querySelector(`.story-item[data-index="${e}"]`);a?.classList.add("active"),a?.scrollIntoView({behavior:"smooth",block:"center"});const r=n[e],o=t[e];o&&r&&(I.setView([r.lat,r.lon],10,{animate:!0}),o.openPopup())}},"/add":new class{constructor(){this._map=null,this._marker=null,this._stream=null}render(){return'\n      <section class="add-story-page container">\n        <h1>Tambah Cerita</h1>\n        <form id="add-story-form" aria-label="Form Tambah Cerita">\n          <div class="form-group">\n            <label for="photo">Foto Cerita</label>\n            <input type="file" id="photo" name="photo" accept="image/*" />\n          </div>\n\n          <div class="form-group camera-controls">\n            <button type="button" id="open-camera" class="btn">üì∑ Gunakan Kamera</button>\n            <button type="button" id="take-photo" class="btn" style="display:none;">Ambil Foto</button>\n            <button type="button" id="close-camera" class="btn" style="display:none;">Tutup Kamera</button>\n            <div id="camera-preview" style="display:none;margin-top:8px;">\n              <video id="camera-video" autoplay playsinline style="max-width:100%;border-radius:8px;"></video>\n              <canvas id="camera-canvas" style="display:none;"></canvas>\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label for="description">Deskripsi</label>\n            <textarea id="description" name="description" rows="4" required></textarea>\n          </div>\n\n          <div class="form-group">\n            <label for="coords">Koordinat (klik peta untuk memilih)</label>\n            <input type="text" id="coords" name="coords" readonly placeholder="Belum dipilih" />\n          </div>\n\n          <div id="mini-map" style="height:300px;border-radius:8px;"></div>\n\n          <div class="form-actions">\n            <button type="submit" id="submit-btn" class="btn">Kirim</button>\n          </div>\n\n          <div id="message" role="status" aria-live="polite"></div>\n        </form>\n      </section>\n    '}async afterRender(){const e=window.L;if(!e)return void(document.getElementById("message").textContent="Leaflet tidak tersedia.");this._map=e.map("mini-map").setView([-6.2,106.816666],5),e.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors"}).addTo(this._map),this._map.on("click",(t=>{const{lat:n,lng:a}=t.latlng;this._marker&&this._marker.remove(),this._marker=e.marker([n,a]).addTo(this._map),document.getElementById("coords").value=`${n.toFixed(6)}, ${a.toFixed(6)}`}));const t=document.getElementById("open-camera"),n=document.getElementById("take-photo"),a=document.getElementById("close-camera"),r=document.getElementById("camera-preview"),o=document.getElementById("camera-video"),i=document.getElementById("camera-canvas"),s=document.getElementById("photo");let l=null;t&&t.addEventListener("click",(async()=>{try{l=await navigator.mediaDevices.getUserMedia({video:!0}),this._stream=l,o.srcObject=l,r.style.display="block",n.style.display="inline-block",a.style.display="inline-block",t.style.display="none"}catch(e){console.error("Camera open failed",e),document.getElementById("message").textContent="Tidak dapat mengakses kamera: "+e.message}})),n&&n.addEventListener("click",(()=>{const e=o.videoWidth,t=o.videoHeight;e&&t&&(i.width=e,i.height=t,i.getContext("2d").drawImage(o,0,0,e,t),i.toBlob((e=>{const t=new File([e],"camera-capture.png",{type:e.type}),n=new DataTransfer;n.items.add(t),s.files=n.files,document.getElementById("message").textContent="Foto diambil, siap dikirim."}),"image/png"))})),a&&a.addEventListener("click",(()=>{l&&(l.getTracks().forEach((e=>e.stop())),this._stream=null),r.style.display="none",n.style.display="none",a.style.display="none",t.style.display="inline-block"}));const d=document.getElementById("add-story-form"),c=document.getElementById("message");d.addEventListener("submit",(async e=>{e.preventDefault(),c.textContent="";const t=document.getElementById("photo"),n=document.getElementById("description").value.trim(),a=document.getElementById("coords").value.trim();let r=null,o=null;if(a){const e=a.split(",").map((e=>e.trim()));r=parseFloat(e[0]),o=parseFloat(e[1])}if(!t.files.length)return void(c.textContent="Pilih foto atau ambil lewat kamera.");const i=t.files[0],s=localStorage.getItem("token");if(s)try{c.textContent="Mengirim...",await _({photoFile:i,description:n,lat:isNaN(r)?null:r,lon:isNaN(o)?null:o,token:s}),c.textContent="Story berhasil dikirim!",d.reset(),this._marker&&(this._marker.remove(),this._marker=null),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null)}catch(e){console.error(e),c.textContent="Gagal mengirim story: "+(e.message||e)}else c.textContent="Anda harus login sebelum mengirim story."}))}},"/login":new class{async render(){return'\n      <section class="login-section">\n        <h1>Masuk ke Aplikasi Story</h1>\n        <form id="login-form" aria-label="Login form">\n          <label for="email">Email</label>\n          <input type="email" id="email" name="email" required />\n\n          <label for="password">Password</label>\n          <input type="password" id="password" name="password" required />\n\n          <button type="submit" class="btn primary">Login</button>\n          <p id="login-message" role="alert" aria-live="polite"></p>\n        </form>\n      </section>\n    '}async afterRender(){const e=document.getElementById("login-form"),t=document.getElementById("login-message");e.addEventListener("submit",(async n=>{n.preventDefault();const a=e.email.value.trim(),r=e.password.value.trim();if(a&&r){t.textContent="Memproses login...";try{const e=await async function({email:e,password:t}){const n=await fetch(A.LOGIN,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!n.ok){const e=await n.text();throw new Error(`Login failed: ${n.status} ${e}`)}return await n.json()}({email:a,password:r}),n=e?.loginResult?.token||null;if(!n){const n=e?.message||"Token tidak ditemukan.";return void(t.textContent=`Login gagal: ${n}`)}localStorage.setItem("token",n);const o=e?.loginResult?.name||"";o&&localStorage.setItem("userName",o),t.textContent="Login berhasil! Mengalihkan...",setTimeout((()=>{window.location.hash="#/"}),1e3)}catch(e){t.textContent=`Error: ${e.message}`}}else t.textContent="Email dan Password harus diisi."}))}},"/register":new class{async render(){return'\n      <section class="container page">\n        <h1 id="register-title">Daftar Akun Baru</h1>\n        <p>Silahkan isi form di bawah ini untuk membuat akun baru.</p>\n\n        <form id="register-form" aria-labelledby="register-title">\n          <div class="form-group">\n            <label for="name">Nama Lengkap</label>\n            <input \n              type="text" \n              id="name" \n              name="name"\n              placeholder="Masukkan nama lengkap Anda"\n              aria-required="true"\n              required\n            />\n          </div>\n\n          <div class="form-group">\n            <label for="email">Email</label>\n            <input \n              type="email" \n              id="email" \n              name="email"\n              placeholder="Masukkan email aktif"\n              aria-required="true"\n              required\n            />\n          </div>\n\n          <div class="form-group">\n            <label for="password">Password</label>\n            <input \n              type="password" \n              id="password" \n              name="password"\n              placeholder="Buat password minimal 8 karakter"\n              aria-required="true"\n              required\n            />\n          </div>\n\n          <button type="submit" class="btn-primary">Daftar</button>\n        </form>\n\n        <p>Sudah punya akun? <a href="#/login">Login</a></p>\n      </section>\n    '}async afterRender(){document.getElementById("register-form").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("name").value.trim(),n=document.getElementById("email").value.trim(),a=document.getElementById("password").value.trim();if(a.length<8)alert("Password minimal 8 karakter.");else try{const e=await fetch("https://story-api.dicoding.dev/v1/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:n,password:a})}),r=await e.json();e.ok&&!r.error?(alert("Registrasi berhasil! Silakan login."),window.location.hash="/login"):alert("Registrasi gagal: "+r.message)}catch(e){alert("Terjadi kesalahan koneksi. Coba lagi."),console.error(e)}}))}}},B={parseActiveUrl(){let e=(window.location.hash||"#/").replace("#","");return e.startsWith("/")||(e=`/${e}`),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e||"/"}};async function H(){const e=B.parseActiveUrl(),t=$[e]||$["/"],n=document.getElementById("main-content");var a;document.startViewTransition?document.startViewTransition((async()=>{n.innerHTML=await t.render(),await(t.afterRender?.())})):(n.innerHTML=await t.render(),await(t.afterRender?.())),a=e,document.querySelectorAll("#nav-list a").forEach((e=>{const t=e.getAttribute("href").replace("#","");e.classList.toggle("active",t===a)})),P()}function P(){const e=localStorage.getItem("token"),t=document.getElementById("login-link"),n=document.getElementById("register-link"),a=document.getElementById("logout-link");t&&n&&a&&(e?(t.style.display="none",n.style.display="none",a.style.display="inline-block"):(t.style.display="inline-block",n.style.display="inline-block",a.style.display="none"))}"serviceWorker"in navigator&&window.addEventListener("load",(async()=>{try{const e=await function(e,t=8e3){return Promise.race([e,new Promise(((e,n)=>setTimeout((()=>n(new Error("timeout"))),t)))])}(navigator.serviceWorker.register("/sw.js"),7e3);console.log("ServiceWorker registered:",e),r.e(978).then(r.bind(r,978)).then((t=>{if(console.log("‚úÖ Push notification module loaded"),t&&"function"==typeof t.initPush)try{t.initPush(e),console.log("‚úÖ Push notification initialized with registration")}catch(e){console.warn("‚ö†Ô∏è initPush failed, retrying without registration:",e);try{t.initPush(null),console.log("‚úÖ Push notification initialized without registration")}catch(e){console.warn("‚ùå initPush retry failed:",e)}}})).catch((e=>{console.warn("‚ö†Ô∏è Could not load push-notification module:",e),r.e(978).then(r.bind(r,978)).catch((e=>{console.error("‚ùå Failed to load push notification module:",e)}))}))}catch(e){console.error("ServiceWorker registration failed or timed out:",e)}})),window.addEventListener("hashchange",(()=>{"#/logout"===window.location.hash&&(localStorage.removeItem("token"),alert("Anda telah logout"),window.location.hash="/",P())})),window.addEventListener("hashchange",H),window.addEventListener("load",H);const j=document.getElementById("drawer-button"),C=document.getElementById("navigation-drawer");async function M(){try{const e=await async function(){try{const e=await S();if(!e.objectStoreNames.contains(k))return console.warn("[idb] Outbox store tidak tersedia"),[];const t=e.transaction(k,"readonly").objectStore(k);return new Promise(((e,n)=>{const a=t.getAll();a.onsuccess=()=>e(a.result||[]),a.onerror=()=>{console.error("[idb] Error getting outbox:",a.error),e([])}}))}catch(e){return console.error("[idb] Error getting outbox:",e),[]}}();if(!e||0===e.length)return;console.log("Syncing outbox items:",e.length);for(const t of e)try{await _(t)}catch(e){console.error("Failed to sync item, will retry later:",t,e)}await async function(){try{const e=await S();if(!e.objectStoreNames.contains(k))return void console.warn("[idb] Outbox store tidak tersedia untuk clear");const t=e.transaction(k,"readwrite").objectStore(k);return new Promise(((e,n)=>{const a=t.clear();a.onsuccess=()=>e(),a.onerror=()=>{console.error("[idb] Error clearing outbox:",a.error),e()}}))}catch(e){console.error("[idb] Error clearing outbox:",e)}}(),console.log("Outbox sync finished.")}catch(e){console.error("Error during outbox sync:",e)}}j?.addEventListener("click",(()=>C?.classList.toggle("open"))),window.updateNavigation=P,window.addEventListener("click",(e=>{e.target.matches('a[href="#/logout"]')&&(e.preventDefault(),localStorage.removeItem("token"),alert("Anda telah logout"),P(),window.location.hash="/")})),window.addEventListener("online",(()=>{console.log("Network status: online ‚Äî attempting to sync outbox"),setTimeout((()=>M()),0)})),navigator.onLine&&setTimeout((()=>{M().catch((e=>console.warn("Initial outbox sync error:",e)))}),1e3)})();