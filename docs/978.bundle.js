"use strict";(self.webpackChunkstory_app_zaky=self.webpackChunkstory_app_zaky||[]).push([[978],{978:(t,e,n)=>{n.r(e),n.d(e,{initPush:()=>o});const r={BASE_URL:"https://story-api.dicoding.dev/v1"};async function o(t){try{t||(t=await navigator.serviceWorker.ready)}catch(t){return void console.warn("Service worker not ready, push init aborted.",t)}let e=document.getElementById("push-toggle");async function n(){try{const n=await t.pushManager.getSubscription();"granted"===Notification.permission&&n?e.textContent="Disable Notifications":e.textContent="Enable Notifications"}catch(t){console.error("Error while updating push UI",t),e.textContent="Enable Notifications"}}e||(e=document.createElement("button"),e.id="push-toggle",e.setAttribute("type","button"),e.style.position="fixed",e.style.left="8px",e.style.bottom="8px",e.style.zIndex="9999",document.body.appendChild(e)),await n(),e.addEventListener("click",(async()=>{try{if("granted"===Notification.permission){const e=await t.pushManager.getSubscription();if(e){const t=await e.unsubscribe();console.log("Unsubscribed locally:",t);try{await async function(t){const e="/v1/unsubscribe",n=r&&r.BASE_URL?`${r.BASE_URL.replace(/\/$/,"")}/v1/unsubscribe`:null;async function o(e){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const t=await n.text().catch((()=>""));throw new Error(`Server responded ${n.status} ${n.statusText} ${t}`)}return n.json().catch((()=>({})))}try{return await o(e)}catch(t){if(console.warn(`Unsubscribe post to ${e} failed:`,t),n)try{return await o(n)}catch(t){throw console.error(`Unsubscribe post to fallback ${n} failed:`,t),t}throw t}}({endpoint:e.endpoint,keys:e.toJSON().keys})}catch(t){console.warn("Failed to remove subscription from server",t)}}return void await n()}if("granted"!==await Notification.requestPermission())return void alert("Permission for notifications was not granted.");const e=await async function(){try{const t=await fetch(`${r.BASE_URL}/vapidPublicKey`);if(!t.ok)throw new Error(`Failed to fetch VAPID key: ${t.status}`);const e=await t.json();return e.publicKey||e.public||e}catch(t){return console.error("Error fetching VAPID public key:",t),"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}}();if(!e)return void alert("Gagal mendapatkan VAPID public key dari server.");const o=function(t){const e=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(e),r=new Uint8Array(n.length);for(let t=0;t<n.length;++t)r[t]=n.charCodeAt(t);return r}(e),a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o});console.log("Push subscription object:",a);try{await async function(t){const e="/v1/subscribe",n=r&&r.BASE_URL?`${r.BASE_URL.replace(/\/$/,"")}/v1/subscribe`:null;async function o(e){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const t=await n.text().catch((()=>""));throw new Error(`Server responded ${n.status} ${n.statusText} ${t}`)}return n.json().catch((()=>({})))}try{return await o(e)}catch(t){if(console.warn(`Posting subscription to ${e} failed:`,t),n)try{return await o(n)}catch(t){throw console.error(`Posting subscription to fallback ${n} failed:`,t),t}throw t}}(a),alert("Subscription saved to server.")}catch(t){console.error("Failed to send subscription to server:",t),alert("Gagal mengirim subscription ke server. Cek console.");try{await a.unsubscribe()}catch(t){console.warn("Failed to unsubscribe after failed server save",t)}}await n()}catch(t){console.error("Error in push toggle handler",t),alert("Terjadi kesalahan saat menyiapkan notifikasi. Lihat console.")}}))}}}]);